
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="../../assets/img/favicon.png">
  <link rel="icon" type="image/png" href="../../assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Khadec Tech - Newsletters
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
  <!-- CSS Files -->
  <link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../assets/css/paper-dashboard.css" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="../assets/demo/demo.css" rel="stylesheet" />
  <link
  href="../../assets/vendor/bootstrap-icons/bootstrap-icons.css"
  rel="stylesheet"
/>
</head>

<body class="">
      <!--Modal class -->
      <div class="modal fade show" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content" id="modalContent">
  
          </div>
        </div>
      </div>

  <div class="wrapper ">
    <div class="sidebar" data-color="white" data-active-color="danger">
      <div class="logo">
          <div class="top">
            <a class="simple-text logo-mini">
              <div class="logo-image-small">
                <img src="../assets/img/logo-small.png" />
              </div>
              <!-- <p>CT</p> -->
            </a>
            <a class="simple-text logo-small">
              Khadec Admin
            </a>
          </div>
          <a  id="signed-user"></a>
      </div>
      <div class="sidebar-wrapper" style="overflow: hidden">
        <ul class="nav">
          <li class="">
            <a href="./dashboard.html">
              <i class="bi bi-currency-dollar"></i>
              <p>Pricing</p>
            </a>
          </li>
          <li class="">
            <a href="./portfolio.html">
              <i class="bi bi-book-half"></i>
              <p>Portfolio</p>
            </a>
          </li>
          <li>
            <a href="./newsletters.html">
              <i class="fa fa-envelope"></i>
              <p>Newsletters</p>
            </a>
          </li>
          <li>
            <a href="./payment_subs.html">
              <i class="fa fa-credit-card"></i>
              <p>Payment Subscribers</p>
            </a>
          </li>
          <li class="active-pro" id="userLogout">
            <a>
              <i class="nc-icon nc-spaceship"></i>
              <p>Log Out</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" href="javascript:;">Dashboard</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <form>
              <div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <div class="input-group-append">
                  <div class="input-group-text">
                    <i class="nc-icon nc-zoom-split"></i>
                  </div>
                </div>
              </div>
            </form>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link btn-magnify" href="javascript:;">
                  <i class="nc-icon nc-layout-11"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Stats</span>
                  </p>
                </a>
              </li>
              <li class="nav-item btn-rotate dropdown">
                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="nc-icon nc-bell-55"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Some Actions</span>
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#">Action</a>
                  <a class="dropdown-item" href="#">Another action</a>
                  <a class="dropdown-item" href="#">Something else here</a>
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link btn-rotate" href="javascript:;">
                  <i class="nc-icon nc-settings-gear-65"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Account</span>
                  </p>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="row">
          <div class="col-md-5">
            <div class="card">
              <div class="card-header">
                <h4 class="card-title">Subscribers</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table">
                    <thead class=" text-primary">
                      <th>
                        Emails
                      </th>
                      <th class="text-right">
                        Remove
                      </th>
                    </thead>
                    <tbody id="subscribers_table">
               
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-7">
            <div class="card card-user">
              <div class="card-header">
                <h5 class="card-title">Send Emails</h5>
              </div>
              <div class="card-body">
                <form id="send_emails_form">
                  <div class="row">
                    <div class="col-md-5 pr-1">
                      <div class="form-group">
                        <label>Email Type</label>
                        <input type="text" class="form-control" disabled="" placeholder="Newsletter" value="Newsletter">
                      </div>
                    </div>
                    <div class="col-md-3 px-1">
                      <div class="form-group">
                        <label>Subject</label>
                        <input type="text" class="form-control" placeholder="subject" value="" id="subject">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="form-group">
                        <label>Body</label>
                        <textarea class="form-control textarea" id="message_body">Oh so, your weak rhyme You doubt I'll bother, reading into it</textarea>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="update ml-auto mr-auto">
                      <button type="submit" class="btn btn-primary btn-round">Send Email</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer footer-black  footer-white ">
        <div class="container-fluid">
          <div class="row">
            <div class="credits ml-auto">
              <span class="copyright">
                Â© <script>
                  document.write(new Date().getFullYear())
                </script>, made with <i class="fa fa-heart heart"></i> by Khadec Technologies
              </span>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>
  <!--   Core JS Files   -->
  <script src="../assets/js/core/jquery.min.js"></script>
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!-- Chart JS -->
  <script src="../assets/js/plugins/chartjs.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/paper-dashboard.min.js" type="text/javascript"></script><!-- Paper Dashboard DEMO methods, don't include it in your project! -->
  <script src="../assets/demo/demo.js"></script>
  <script src="https://smtpjs.com/v3/smtp.js"></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, set, ref, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, uploadBytesResumable, deleteObject  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
    import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCuyHGrJ_7WMP_V0QGbbZWOYDS_oVA_gaA",
      authDomain: "khadec-tech.firebaseapp.com",
      databaseURL: "https://khadec-tech-default-rtdb.firebaseio.com",
      projectId: "khadec-tech",
      storageBucket: "khadec-tech.appspot.com",
      messagingSenderId: "623072304859",
      appId: "1:623072304859:web:bbb275fbd6773aa6cfb6fe"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

      onAuthStateChanged(auth, (user) => {
        if(user){
          var uid = user.uid;
          var myEmail = user.email;

          document.getElementById('signed-user').innerHTML = myEmail;
        }else{
          window.location.href = '../../adminLogin.html'
        }
      })

          
      const subscribersRef = ref(database, 'subscribers/');
      onValue(subscribersRef, (snapshot) => {
        localStorage.setItem('Subscribers', JSON.stringify(snapshot))
      });

    const localSubs = JSON.parse(localStorage.getItem('Subscribers'));
    const mySubs = [];

    // ..Load the subscribers
    for(let subscriber in localSubs){
      mySubs.push(localSubs[subscriber].email);

      document.getElementById('subscribers_table').innerHTML += `
        <tr id="${subscriber}">
          <td>
            ${localSubs[subscriber].email}
          </td>
          <td class="text-right">
            <i class="bi bi-trash-fill deleteBtn" style='color: red; cursor: pointer;'></i>
          </td>
        </tr>
      `
    }

    function showSignUpModal(){
      const myModalEl = document.getElementById('staticBackdrop')
      const modal = new bootstrap.Modal(myModalEl)
      modal.show()  
    }

    function strtLoading(){
        let modContent = `
            <div class="modal-header">
              <h5 class="mb-0">Sending emails</h5>
            </div>
          <div class="modal-body">
            <h5>Please wait...</h5>
            <!-- Modal Spinner -->
            <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-warning" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-success" role="status">
              <span class="visually-hidden"></span>
            </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        showSignUpModal();
      }

    function strtLoadingDelete(email, emailID){

      let modContent = `
        <div class="modal-body p-4 text-center">
          <h5 class="mb-0">Remove subscriber</h5>
          <p class="mb-0">Are you sure you want to remove ${email} from your subscribers ?</p>
        </div>
        <div class="modal-footer flex-nowrap p-0">
          <button type="button" class="btn btn-lg btn-link btn-danger fs-6 text-decoration-none col-12 m-0 rounded-0 border-right" id="yesDelete"><strong>Yes, delete</strong></button>
        </div>
      `
      document.getElementById('modalContent').innerHTML = modContent;
      showSignUpModal();

      document.getElementById('yesDelete').addEventListener('click', (e) => {
        let modContent = `
        <div class="modal-body p-4 text-center">
          <h5 class="mb-0">Removing email</h5>
          <p class="mb-0">Please wait</p>
          <div class="modal-body">
            <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
            </div>
            <div class="spinner-grow spinner-grow-sm text-warning" role="status">
            </div>
            <div class="spinner-grow spinner-grow-sm text-success" role="status">
            </div>
          </div>
        </div>
      `
      document.getElementById('modalContent').innerHTML = modContent;
        remove(ref(database,"subscribers/"+emailID))
        .then(()=>{
          let modContent = `
            <div class="modal-body p-4 text-center">
              <h5 class="mb-0">Done</h5>
              <p class="mb-0">Email successfully removed.</p>
            </div>
            <div class="modal-footer flex-nowrap p-0">
              <button type="button" class="btn btn-lg btn-link btn-success fs-6 text-decoration-none col-12 m-0 rounded-0" id="refreshPage"><strong>Ok</strong></button>
            </div>
          `
          document.getElementById('modalContent').innerHTML = modContent;
          document.getElementById('refreshPage').addEventListener('click', () => {
            window.location.reload();
          })

            }).catch((error)=>{
                let modContent = `
                <div class="modal-body p-4 text-center">
                  <h5 class="mb-0">Email remove unsuccessful</h5>
                  <p class="mb-0">${error}.</p>
                </div>
                <div class="modal-footer flex-nowrap p-0">
                  <button type="button" class="btn btn-lg btn-link btn-danger fs-6 text-decoration-none col-12 m-0 rounded-0" id="refreshPage"><strong>Try Again</strong></button>
                </div>
              `
              document.getElementById('modalContent').innerHTML = modContent;
            });
        })
      }

      function finishedLoading(){
       let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Done.</h5>
            </div>
          <div class="modal-body">
            <h5>Emails successfully sent.</h5>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="refreshPage">Close</button>
          </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        // document.getElementById('refreshPage').addEventListener('click', refresh)
      }

      function finishedLoadingError(error){
       let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Error.</h5>
            </div>
          <div class="modal-body">
            <h5>Emails not sent</h5>
            <p>${error}</p>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="refreshPage">Close</button>
          </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        // document.getElementById('refreshPage').addEventListener('click', refresh)
      }
  
  var deleteBtns = document.querySelectorAll('.deleteBtn');
  deleteBtns.forEach((item) => {
    item.addEventListener('click', (e) => {
      let emailID = e.target.parentElement.parentElement.id;
      let email = e.target.parentElement.previousElementSibling.textContent;
      strtLoadingDelete(email, emailID)
    })
  })

  // ..Send subscriber emails
      document.getElementById('send_emails_form').addEventListener('submit', (e) => {

      e.preventDefault();
      if(mySubs.length == 0){
        let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Error.</h5>
            </div>
          <div class="modal-body">
            <h5>Sorry man :(</h5>
            <p>You ain't got no subscribers yet</p>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="refreshPage">Close</button>
          </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        showSignUpModal();
      }else{
      // show loading
        strtLoading();
        
        Email.send({
          Host : "smtp.elasticemail.com",
          Username : "khadectech21@gmail.com",
          Password : "3B6024D1E8031DDD5A75BFC9F16277B04E82",
          To : `${mySubs.map((item) => {return item})}`,
          From : "khadectech21@gmail.com",
          Subject : document.getElementById('subject').value,
          Body : document.getElementById('message_body').value
              
          }).then(
              message => {
                if(message = "ok"){
                  finishedLoading();
                }
            }).catch((error) => {
          finishedLoadingError(error)
        })
      }

      // show success after sent email
    })

    // User logout
    document.getElementById('userLogout').addEventListener('click', () => {
      signOut(auth).then(() => {
        // Sign-out successful.       
        window.location.href = '../../adminLogin.html'; 
      }).catch((error) => {
        // An error happened.
      });
    })

  </script>
</body>

</html>