
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="../../assets/img/favicon.png">
  <link rel="icon" type="image/png" href="../../assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Khadec Tech - Payment Subscribers
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
  <!-- CSS Files -->
  <link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../assets/css/paper-dashboard.css" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="../assets/demo/demo.css" rel="stylesheet" />
  <link
  href="../../assets/vendor/bootstrap-icons/bootstrap-icons.css"
  rel="stylesheet"
/>
</head>

<body class="">

      <!--Add subscriberModal class -->
      <div class="modal fade show" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content"  style="background-color: rgb(233, 233, 233);">
              <div class="modal-header">
                <h5 class="modal-title">New subscriber</h5>
              </div>
              <div class="modal-body">
                <!-- Loan details -->
              <div class="modal-header">
                <form class="row g-3">
                  <div class="col-md-8">
                    <!-- <div class=""> -->
                      <label for="p_sized_photo2">Choose logo</label>
                      <input type="file" class="form-control" id="p_sized_photo2">
                    <!-- </div> -->
                  </div>
                </form>
                </div>
                
                <form class="row g-3" id="add_sub_form">
                  <div class="col-md-4">
                    <label for="interest_rate">Company/Business name</label>
                    <div class="">
                      <input type="text" class="form-control" id="company_name">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label for="interest_rate">Email address</label>
                    <div class="">
                      <input type="text" class="form-control" id="email_address">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label for="interest_rate">Phone number</label>
                    <div class="">
                      <input type="text" class="form-control" id="phone_number">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label for="p_sized_photo2">Plan /Monthly</label>
                    <div class="">
                      <input type="text" class="form-control" id="pay_plan" placeholder="5.00">
                    </div>
                  </div>
                  <div class="col-md-8">
                    <label for="interest_rate">Physical address</label>
                    <div class="">
                      <input type="text" class="form-control" id="physical_address">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="">
                      <label for="webiste">Website URL</label>
                      <input type="text" class="form-control" id="website">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="">
                      <label for="webiste">Password</label>
                      <input type="text" class="form-control" id="password1">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="">
                      <label for="webiste">Confirm password</label>
                      <input type="text" class="form-control" id="password2">
                    </div>
                  </div>
                </form>
              </div>
    
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="add_subscriber">Add Subscriber</button>
              </div>
            </div>
          </div>
      </div>

      
      <!--View subscriberModal class -->
      <div class="modal fade show" id="staticBackdrop3" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="viewModalDetails" style="background-color: rgb(233, 233, 233);">
            
            
            </div>
          </div>
      </div>
      
      <!--View subscriberModal class -->
      <div class="modal fade show" id="staticBackdrop4" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="sendEmailsModal" style="background-color: rgb(233, 233, 233);">
            
            
            </div>
          </div>
      </div>

      <!--Modal class -->
      <div class="modal fade show" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content" id="modalContent">

        </div>
      </div>
    </div>
    
  <div class="wrapper ">
    <div class="sidebar" data-color="white" data-active-color="danger">
      <div class="logo">
          <div class="top">
            <a class="simple-text logo-mini">
              <div class="logo-image-small">
                <img src="../assets/img/logo-small.png" />
              </div>
              <!-- <p>CT</p> -->
            </a>
            <a class="simple-text logo-small">
              Khadec Admin
            </a>
          </div>
          <a  id="signed-user"></a>
      </div>
      <div class="sidebar-wrapper" style="overflow: hidden">
        <ul class="nav">
          <li class="">
            <a href="./dashboard.html">
              <i class="bi bi-currency-dollar"></i>
              <p>Pricing</p>
            </a>
          </li>
          <li class="">
            <a href="./portfolio.html">
              <i class="bi bi-book-half"></i>
              <p>Portfolio</p>
            </a>
          </li>
          <li>
            <a href="./newsletters.html">
              <i class="fa fa-envelope"></i>
              <p>Newsletters</p>
            </a>
          </li>
          <li class="active">
            <a href="./payment_subs.html">
              <i class="fa fa-credit-card"></i>
              <p>Payment Subscribers</p>
            </a>
          </li>
          <li class="active-pro" id="userLogout">
            <a>
              <i class="nc-icon nc-spaceship"></i>
              <p>Log Out</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" href="javascript:;">Dashboard</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <form>
              <div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <div class="input-group-append">
                  <div class="input-group-text">
                    <i class="nc-icon nc-zoom-split"></i>
                  </div>
                </div>
              </div>
            </form>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link btn-magnify" href="javascript:;">
                  <i class="nc-icon nc-layout-11"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Stats</span>
                  </p>
                </a>
              </li>
              <li class="nav-item btn-rotate dropdown">
                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="nc-icon nc-bell-55"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Some Actions</span>
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#">Action</a>
                  <a class="dropdown-item" href="#">Another action</a>
                  <a class="dropdown-item" href="#">Something else here</a>
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link btn-rotate" href="javascript:;">
                  <i class="nc-icon nc-settings-gear-65"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Account</span>
                  </p>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="content">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between" style="width: 100%;">
                <h4 class="card-title">Payment Subscribers <span class="badge badge-light position-absolute top-0 start-100 translate-middle" id="totalUsers">0</span></h4>
                <button type="submit" class="btn btn-primary btn-round" id="addNewUser">Add New</button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table">
                    <thead class=" text-primary">
                      <th>
                        Company/Business name
                      </th>
                      <th>
                        Email address
                      </th>
                      <th>
                        Phone number
                      </th>
                      <th>
                        Status
                      </th>
                      <th>
                        Details
                      </th>
                      <th>
                        Reminder
                      </th>
                      <th class="text-right">
                        Remove
                      </th>
                    </thead>
                    <tbody id="subscribers_table">
                
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer footer-black  footer-white ">
        <div class="container-fluid">
          <div class="row">
            <div class="credits ml-auto">
              <span class="copyright">
                Â© <script>
                  document.write(new Date().getFullYear())
                </script>, made with <i class="fa fa-heart heart"></i> by Khadec Technologies
              </span>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!--   Core JS Files   -->
  <script src="../assets/js/core/jquery.min.js"></script>
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
  <!-- Chart JS -->
  <script src="../assets/js/plugins/chartjs.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/paper-dashboard.min.js" type="text/javascript"></script><!-- Paper Dashboard DEMO methods, don't include it in your project! -->
  <script src="../assets/demo/demo.js"></script>
  <script src="https://smtpjs.com/v3/smtp.js"></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, set, ref, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, uploadBytesResumable, deleteObject  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
    import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCuyHGrJ_7WMP_V0QGbbZWOYDS_oVA_gaA",
      authDomain: "khadec-tech.firebaseapp.com",
      databaseURL: "https://khadec-tech-default-rtdb.firebaseio.com",
      projectId: "khadec-tech",
      storageBucket: "khadec-tech.appspot.com",
      messagingSenderId: "623072304859",
      appId: "1:623072304859:web:bbb275fbd6773aa6cfb6fe"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    onAuthStateChanged(auth, (user) => {
    if(user){
        var uid = user.uid;
        var myEmail = user.email;

        document.getElementById('signed-user').innerHTML = myEmail;
    }else{
        window.location.href = '../../adminLogin.html'
    }
    })

    loadSubscribers()

    function showSignUpModal(){
      const myModalEl = document.getElementById('staticBackdrop')
      const modal = new bootstrap.Modal(myModalEl)
      modal.show()  
    }

    function showAddUserModal(){
      const myModalEl = document.getElementById('staticBackdrop2')
      const modal = new bootstrap.Modal(myModalEl)
      modal.show()  
    }

    function showViewUserModal(){
      const myModalEl = document.getElementById('staticBackdrop3')
      const modal = new bootstrap.Modal(myModalEl)
      modal.show()  
    }

    function showSendEmailModal(){
      const myModalEl = document.getElementById('staticBackdrop4')
      const modal = new bootstrap.Modal(myModalEl)
      modal.show()  
    }

    function strtLoading(heading){
        let modContent = `
            <div class="modal-header">
              <h5 class="mb-0">${heading}</h5>
            </div>
          <div class="modal-body">
            <h5>Please wait...</h5>
            <!-- Modal Spinner -->
            <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-warning" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-success" role="status">
              <span class="visually-hidden"></span>
            </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        showSignUpModal();
      }

    function createAcntLoading(){
        let modContent = `
            <div class="modal-header">
              <h5 class="mb-0">Creating a subscriber account</h5>
            </div>
          <div class="modal-body">
            <h5>Please wait...</h5>
            <!-- Modal Spinner -->
            <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-warning" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-success" role="status">
              <span class="visually-hidden"></span>
            </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        showSignUpModal();
      }

    function strtLoadingDelete(deleteBtn){
      deleteBtn.addEventListener('click', (e) => {
        let client_id = e.target.id;

        let modContent = `
        <div class="modal-body p-4 text-center">
          <h5 class="mb-0">Remove subscriber</h5>
          <p class="mb-0">Are you sure you want to remove subscriber with ID ${client_id} from your subscribers ?</p>
        </div>
        <div class="modal-footer flex-nowrap p-0">
          <button type="button" class="btn btn-lg btn-link btn-danger fs-6 text-decoration-none col-12 m-0 rounded-0 border-right" id="yesDelete"><strong>Yes, delete</strong></button>
        </div>
      `
      document.getElementById('modalContent').innerHTML = modContent;
      showSignUpModal();

      document.getElementById('yesDelete').addEventListener('click', (e) => {
        let modContent = `
        <div class="modal-body p-4 text-center">
          <h5 class="mb-0">Removing subscriber</h5>
          <p class="mb-0">Please wait</p>
          <div class="modal-body">
            <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
            </div>
            <div class="spinner-grow spinner-grow-sm text-warning" role="status">
            </div>
            <div class="spinner-grow spinner-grow-sm text-success" role="status">
            </div>
          </div>
        </div>
      `
      document.getElementById('modalContent').innerHTML = modContent;
        remove(ref(database,"userAccounts/"+client_id))
        .then(()=>{
          let modContent = `
            <div class="modal-body p-4 text-center">
              <h5 class="mb-0">Done</h5>
              <p class="mb-0">Subscriber successfully removed.</p>
            </div>
            <div class="modal-footer flex-nowrap p-0">
              <button type="button" class="btn btn-lg btn-link btn-success fs-6 text-decoration-none col-12 m-0 rounded-0" id="refreshPage"><strong>Ok</strong></button>
            </div>
          `
          document.getElementById('modalContent').innerHTML = modContent;
          window.location.reload();
          // document.getElementById('refreshPage').addEventListener('click', () => {
          // })

            }).catch((error)=>{
                let modContent = `
                <div class="modal-body p-4 text-center">
                  <h5 class="mb-0">Subscriber remove unsuccessful</h5>
                  <p class="mb-0">${error}.</p>
                </div>
                <div class="modal-footer flex-nowrap p-0">
                  <button type="button" class="btn btn-lg btn-link btn-danger fs-6 text-decoration-none col-12 m-0 rounded-0" id="refreshPage"><strong>Try Again</strong></button>
                </div>
              `
              document.getElementById('modalContent').innerHTML = modContent;
            });
        })
      })
      
      }

      function finishedLoading(message){
       let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Done.</h5>
            </div>
          <div class="modal-body">
            <h5>${message}</h5>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="refreshPage">Close</button>
          </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        // document.getElementById('refreshPage').addEventListener('click', refresh)
      }

      function finishedLoadingError(error, heading){
       let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Error.</h5>
            </div>
          <div class="modal-body">
            <h5>${heading}</h5>
            <p>${error}</p>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="refreshPage">Close</button>
          </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        // document.getElementById('refreshPage').addEventListener('click', refresh)
      }

      function calcLeftDays(subEndingDate){
        if(new Date().getMonth() < new Date(subEndingDate).getMonth()){
        var goneDays = new Date().getDate() - new Date(subEndingDate).getDate();

        if(new Date().getMonth() % 2 == 0 && new Date().getMonth() != 0){
              return 30 - goneDays;
          }else{
              console.log(new Date(subEndingDate).getFullYear())
              
              return 31 - goneDays;
              }
          }else{
              if(StartDate.getFullYear() !== subEndingDate.getFullYear()){
                  if(StartDate.getDate() < subEndingDate.getDate()){
                      return new Date(subEndingDate).getDate() - new Date().getDate();
                  }else{
                      return 0;
                  }
              }else{
                  return new Date(subEndingDate).getDate() - new Date().getDate();
              }
          }
        }
  
      function loadSubscribers(){
      var totalUsers;
      const subsRef = ref(database, 'userAccounts/');
      onValue(subsRef, (snapshot) => {
        totalUsers = Object.keys(snapshot.val()).length;
        snapshot.forEach(element => {
          const data = element.val();
          var key = element.key;
          // var leftDays = calcLeftDays(data.sub_end_date)

          const userDiv = 
           `
           <tr id="">
              <td>
                  ${data.name}
              </td>
              <td>
                ${data.email}
              </td>
              <td>
                ${data.phone_number}
              </td>
              <td>
                ${data.status === 'Active' ? (
                  `<span class="badge badge-success" style="font-size: small;">Active</span>`
                ) : (
                  `<span class="badge badge-danger" style="font-size: small;">Inactive</span>`
                )}
              </td>
              <td class="text-center">
                  <i class="bi bi-eye-fill viewDetailsBtn" id="${key}" style='cursor: pointer; font-size: large;'></i>
              </td>
              <td>
                ${data.status === 'Active' ? (
                    `<button disabled class="btn btn-primary btn-sm sendReminder">Send Email</button>`
                ) : (
                  `<button class="btn btn-primary btn-sm sendReminder" id="${data.email}">Send Email</button>`
                )}
              </td>
              <td class="text-center">
                  <i class="bi bi-trash-fill deleteBtn" id="${key}" style='color: red; cursor: pointer; font-size: large;'></i>
              </td>
          </tr>
           `
          document.getElementById('subscribers_table').innerHTML += userDiv; 
          document.getElementById('totalUsers').innerHTML = totalUsers;

          // View client details
          var details_btns = document.querySelectorAll('.viewDetailsBtn');
          for(let details_btn of details_btns){
              display_details(details_btn)
          }

          // send reminder
          var sendReminderBtns = document.querySelectorAll('.sendReminder');
          for(let sendReminder of sendReminderBtns){
              sendReminderFunc(sendReminder)
          }

          var deleteBtns = document.querySelectorAll('.deleteBtn');
          for(let deleteBtn of deleteBtns){
            strtLoadingDelete(deleteBtn)
            }

        })
      })
      // Total users count

    }

    function sendReminderFunc(sendReminder){
      sendReminder.addEventListener('click', (e) => {
        let client_id = e.target.id;
        let defaultVal = `
          <h2>Hey</h2>
          <p>I know you there</p>
        `

        const userDiv = `
          <div class="modal-header">
            <h5 class="modal-title">Send a subscription reminder</h5>
          </div>
          <div class="modal-body" id="">
          
            <form class="row g-3 col-md-12 justify-content-between align-items-center" id="loan_form">
              <div class="row">
                <div class="col-md-6">
                  <label for="interest_rate">Email address</label>
                  <div class="">
                    <input type="text" class="form-control" id="send_email_address" value="${client_id}">
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="interest_rate">Subject</label>
                  <div class="">
                    <input type="text" class="form-control" id="send_subject" value="Subscription renewal reminder">
                  </div>
                </div>
                <div class="col-md-12">
                  <label for="interest_rate">Body</label>
                  <div class="">
                    <textarea class="form-control" id="send_body" value="" style="padding: 8px; height: 200px"></textarea>
                  </div>
                </div>
              </div><br>
            </form>
              </div>
    
            <div class="modal-footer">
              <div class="w-100">
                <button type="button" class="btn btn-primary float-left sendEmailReminder" id="">Send Email</button>
              </div>
            </div>`

            document.getElementById('sendEmailsModal').innerHTML = userDiv;

            showSendEmailModal();

            document.querySelector('.sendEmailReminder').addEventListener('click', (e) => {
              strtLoading("Sending your email");
              Email.send({
                Host : "smtp.elasticemail.com",
                Username : "khadectech21@gmail.com",
                Password : "3B6024D1E8031DDD5A75BFC9F16277B04E82",
                To : document.getElementById('send_email_address').value,
                From : "khadectech21@gmail.com",
                Subject : document.getElementById('send_subject').value,
                Body : document.getElementById('send_body').value
                }).then(
                    message => {
                        if(message = "ok"){
                        finishedLoading("Email sent successfully");
                        }
                    }).catch((error) => {
                  finishedLoadingError(error.message, "Email sending failed")
                })
            })
      })
    }

    function display_details(details_btn){
      
        details_btn.addEventListener('click', (e) => {
        let client_id = e.target.id;
        const subsRef = ref(database, 'userAccounts/');
        onValue(subsRef, (snapshot) => {
          snapshot.forEach(element => {
            const data = element.val();
            var key = element.key;

            if(client_id === key){
              const userDiv = `
              <div class="modal-header">
                <h5 class="modal-title">Subscription details</h5>
              </div>
              <div class="modal-body" id="">

              <form class="row g-3 pt-10" id="loan_form">
                  <div class="row col-md-12">
                    <div class="col-md-3 pr-1">
                      ${data.status === "Active" ? (
                        `
                        <label for="category">Status</label>
                        <select name="category" id="edit_status" class="form-control">
                            <option value="Active" selected>Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>`
                      ) : (  `
                        <label for="category">Status</label>
                        <select name="category" id="edit_status" class="form-control">
                            <option value="Active">Active</option>
                            <option value="Inactive" selected>Inactive</option>
                        </select>`
                        )}
                      
                    </div>
                    <div class="col-md-3">
                      <label for="interest_rate">Plan/ Month</label>
                      <div class="input-group">
                        <span class="input-group-text">US$</span>
                        <input type="text" class="form-control" id="plan_value" value="${data.pay_plan}">
                      </div>
                    </div>

                    <div class="col-md-3">
                      <label for="interest_rate">Start Date</label>
                      <div class="">
                        <input type="text" class="form-control" id="start_date" value="${data.sub_start_date}" disabled>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <label for="interest_rate">End Date</label>
                      <div class="">
                        <input type="text" class="form-control" id="end_date" value="${data.sub_end_date}" disabled>
                      </div>
                    </div>

                  </div>
                </form>
                <br>
                <form class="row g-3 col-md-12 justify-content-between align-items-center" id="loan_form">
                  <div class="row col-md-4">
                    <div class="card" style="width: 18rem; height: 15rem; overflow: hidden;">
                      ${data.logo === "None" ? (
                        `<img src="../assets/img/default-company.png" class="card-img-top"  alt="..." width="400">`
                        ) : (
                        `<img src="${data.logo}" class="card-img-top"  alt="..." width="400">`
                      )}
                    </div>
                  </div>
                  <div class="row col-md-8">
                    <div class="col-md-6">
                      <label for="interest_rate">Company/Business name</label>
                      <div class="">
                        <input type="text" class="form-control" id="edit_company_name" value="${data.name}">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="interest_rate">Email address</label>
                      <div class="">
                        <input type="text" class="form-control" id="edit_email_address" value="${data.email}">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="interest_rate">Phone number</label>
                      <div class="">
                        <input type="text" class="form-control" id="edit_phone_number" value="${data.phone_number}">
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="">
                        <label for="webiste">Website URL</label>
                        <input type="text" class="form-control" id="edit_website" value="${data.web_url}">
                      </div>
                    </div>
                    <div class="col-md-12">
                      <label for="interest_rate">Physical address</label>
                      <div class="">
                        <input type="text" class="form-control" id="edit_physical_address" value="${data.physical_address}">
                      </div>
                    </div>
                  </div><br>
                </form>
              </div>
    
            <div class="modal-footer">
              <div class="w-100">
                <button type="button" class="btn btn-primary float-left applyEditChanges" id="${client_id}">Apply Changes</button>
              </div>
            </div>
              `
              document.getElementById('viewModalDetails').innerHTML = userDiv;

              document.getElementById('edit_status').addEventListener('change', (e) => {
                console.log(e.target.value)
                if(e.target.value === "Active"){
                  let startDate = new Date().toDateString();
                  let endDate = getSubEndingdate(new Date(startDate));

                  document.getElementById('start_date').value = startDate;
                  document.getElementById('end_date').value = endDate;

                  // Get the subscription end date
                  function getSubEndingdate (subStartDate){
                      var subEndMonth;
                      var subEndYear;

                      var subEndMonthTemp = subStartDate.getMonth() + 2;
                          if(subEndMonthTemp < 13){
                              subEndMonth = subEndMonthTemp;
                              subEndYear = subStartDate.getFullYear()

                          }else{
                              subEndYear = subStartDate.getFullYear() + 1;
                              subEndMonth = subEndMonthTemp - 12;
                      }

                      return new Date(`${subEndMonth} ${subStartDate.getDate()} ${subEndYear}`).toDateString();
                  }
                }
              })

              document.querySelector('.applyEditChanges').addEventListener('click', (e) => {
                let clientID = e.target.id;
                strtLoading('Updating subscriber changes')
                update(ref(database, 'userAccounts/' + clientID),{
                  name: document.getElementById('edit_company_name').value,
                  email: document.getElementById('edit_email_address').value,
                  phone_number: document.getElementById('edit_phone_number').value,
                  physical_address: document.getElementById('edit_physical_address').value,
                  web_url: document.getElementById('edit_website').value,
                  status: document.getElementById('edit_status').value,
                  sub_start_date: document.getElementById('start_date').value,
                  pay_plan: document.getElementById('plan_value').value,
                  sub_end_date: document.getElementById('end_date').value
              }).then(() => {
                finishedLoading('Subscriber details updated successfully')
                window.location.reload();

              }).catch((error) => {
                finishedLoadingError(error.message, "Update failed")
              })
              })
            }
          })
        })

        showViewUserModal();
      })
    }

    document.getElementById('addNewUser').addEventListener('click', (e) => {
        showAddUserModal()
    })


    // Add new subscriber
    document.getElementById('add_subscriber').addEventListener('click', (e) => {
      e.preventDefault()
      createAcntLoading();

      var imageName = new Date().getTime().toString();

      const validatePassword = () =>{
        let isValid = true;
        if(document.getElementById('password1').value !== '' && document.getElementById('password2').value !== ''){
          if(document.getElementById('password1').value !== document.getElementById('password2').value){
            isValid = false;
            finishedLoadingError("Your passwords don't match", "Account not created");
          }
        }
        return isValid;
      };

      if(validatePassword()){
      createUserWithEmailAndPassword(
        auth, 
        document.getElementById('email_address').value, 
        document.getElementById('password2').value
        )
        .then((userCredential) => {
          // Signed in 
          const user = userCredential.user;
          // ...
          UploadAgentProImg();

      //Upload Account logo to the database
          function UploadAgentProImg(){
            const indProfImg = document.getElementById('p_sized_photo2').files[0]
            if(document.getElementById('p_sized_photo2').files.length === 1){
             
              const IndsRef = storageRef(storage, "Logos/" + imageName);
              const indUploadTask = uploadBytesResumable(IndsRef, indProfImg);
              
              indUploadTask.on('state-changed', (snapshot) => {
                // loadLab.innerHTML =GetImgUploadProgress();
              },
              (error)=>{
                alert("error: Image upload failed")
              },

              () => {
                getDownloadURL(indUploadTask.snapshot.ref).then((downloadURL) => {
                  console.log("Logo Uploaded.")
                  uploadAgntInfo(downloadURL);
                });
              });
            }else{
              ///..Go to the next function
              uploadAgntInfo("None");
            }
          };

          function uploadAgntInfo(logoUrl){
            set(ref(database, 'userAccounts/' + userCredential.user.uid),{
              imageName: imageName,
              name: document.getElementById('company_name').value,
              email: document.getElementById('email_address').value,
              phone_number: document.getElementById('phone_number').value,
              logo: logoUrl,
              physical_address: document.getElementById('physical_address').value,
              pay_plan: document.getElementById('pay_plan').value,
              web_url: document.getElementById('website').value,
              status: "inactive",
              sub_start_date: new Date().toDateString(),
              sub_end_date: new Date().toDateString(),
          })
          console.log("subscriber account created successfully.")
          finishedLoading("Subscriber account created successfully.");
          document.getElementById('add_sub_form').reset();
          window.location.reload();
          }

        }).catch((error) => {
          let errorMessage = error.message.replace(/[()-]/g," ");
          let errorMsg = errorMessage.replace('Firebase:',"");
          finishedLoadingError(errorMsg, 'Account not created');
        });  
    } 

    })


    // User logout
    document.getElementById('userLogout').addEventListener('click', () => {
      signOut(auth).then(() => {
        // Sign-out successful.       
        window.location.href = '../../adminLogin.html'; 
      }).catch((error) => {
        // An error happened.
      });
    })

  </script>
</body>

</html>