
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="../../assets/img/favicon.png">
  <link rel="icon" type="image/png" href="../../assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Khadec Admin Dashboard
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
  <!-- CSS Files -->
  <link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../assets/css/paper-dashboard.css" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="../assets/demo/demo.css" rel="stylesheet" />
  <link href="../../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
  
</head>

<body class="">

    <!--Modal class -->
    <div class="modal fade show" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content" id="modalContent">

        </div>
      </div>
    </div>
  
  <div class="wrapper ">
    <div class="sidebar" data-color="white" data-active-color="danger">
      <div class="logo">
          <div class="top">
            <a class="simple-text logo-mini">
              <div class="logo-image-small">
                <img src="../assets/img/logo-small.png" />
              </div>
              <!-- <p>CT</p> -->
            </a>
            <a class="simple-text logo-small">
              Khadec Admin
              <!-- <div class="logo-image-big">
              <img src="../assets/img/logo-big.png">
            </div> -->
            </a>
          </div>
          <a  id="signed-user"></a>
      </div>
      <div class="sidebar-wrapper" style="overflow: hidden">
        <ul class="nav">
          <li class="">
            <a href="./dashboard.html">
              <i class="bi bi-currency-dollar"></i>
              <p>Pricing</p>
            </a>
          </li>
          <li class="active">
            <a href="./portfolio.html">
              <i class="bi bi-book-half"></i>
              <p>Portfolio</p>
            </a>
          </li>
          <li>
            <a href="./newsletters.html">
              <i class="fa fa-envelope"></i>
              <p>Newsletters</p>
            </a>
          </li>
          <li>
            <a href="./payment_subs.html">
              <i class="fa fa-credit-card"></i>
              <p>Payment Subscribers</p>
            </a>
          </li>
          <li class="active-pro" id="userLogout">
            <a>
              <i class="nc-icon nc-spaceship"></i>
              <p>Log Out</p>
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" href="javascript:;">Dashboard</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <form>
              <div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <div class="input-group-append">
                  <div class="input-group-text">
                    <i class="nc-icon nc-zoom-split"></i>
                  </div>
                </div>
              </div>
            </form>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link btn-magnify" href="javascript:;">
                  <i class="nc-icon nc-layout-11"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Stats</span>
                  </p>
                </a>
              </li>
              <li class="nav-item btn-rotate dropdown">
                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="nc-icon nc-bell-55"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Some Actions</span>
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#">Action</a>
                  <a class="dropdown-item" href="#">Another action</a>
                  <a class="dropdown-item" href="#">Something else here</a>
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link btn-rotate" href="javascript:;">
                  <i class="nc-icon nc-settings-gear-65"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Account</span>
                  </p>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->

      <!-- Main Content -->
      <div class="content" id="mainContent">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header d-flex" style="justify-content: space-between;">
                <h4 class="card-title"> Portfolio</h4>
                <button type="submit" class="btn btn-primary btn-round" id="add_new_portfolio">Add New</button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table" style="overflow: hidden;">
                    <thead class=" text-primary">
                      <th>
                        Client
                      </th>
                      <th>
                        Date
                      </th>
                      <th>
                        Caregory
                      </th>
                      <th class="text-right">
                        Delete
                      </th>
                    </thead>
                    <tbody style="overflow: hidden;" id="portfolio_list">
                
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload portfolio -->
      <div class="content d-none" id="uploadPortfolio">
        <div class="row">
          <div class="col-md-12">
            <div class="card card-user">
              <div class="card-header d-flex" style="justify-content: space-between;">
                <h5 class="card-title">New Portfolio Item</h5>
                <button type="submit" class="btn btn-primary btn-round" id="view_portfolio">View Portfolio</button>
              </div>
              <div class="card-body" style="overflow-x: hidden;">
                <form>
                  <div class="row">
                    <div class="col-md-5 pr-1">
                      <div class="form-group">
                        <label>Item (disabled)</label>
                        <input type="text" class="form-control" disabled placeholder="Company" value="Portfolio.">
                      </div>
                    </div>
                    <div class="col-md-3 px-1">
                      <div class="form-group">
                        <label>Title</label>
                        <input type="text" class="form-control" placeholder="Project title" id="proTitle">
                      </div>
                    </div>
                    <div class="col-md-4 pl-1">
                      <div class="form-group">
                        <label for="exampleInputEmail1">Client</label>
                        <input type="text" class="form-control" placeholder="Project client" id="proClient">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 pr-1">
                      <div class="form-group">
                        <label for="category">Choose category</label>
                        <select name="category" id="category" class="form-control">
                            <option value="web">Website</option>
                            <option value="app">Application</option>
                            <option value="design">Graphic Design</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6 pl-1">
                      <div class="form-group">
                        <label>Project date</label>
                        <input type="date" class="form-control" placeholder="Last Name" id="proDate">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="form-group">
                        <label>Project URL</label>
                        <input type="text" class="form-control" placeholder="Project URL" id="proUrl">
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-3 pr-1">
                      <div class="form-group">
                        <label for="images">Gallery Images</label>
                        <div class="buttons d-flex">
                          <button class="imagesSelect" id="progallery_images" style="font-size: 18px; width: 80px;">Add</button>
                          <button class="imagesClear" id="clear_images" style="font-size: 18px; width: 80px;">Clear</button>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-8 px-1" style="overflow-x: scroll;">
                      <div class="form-group">
                        <div id="imgdiv" class="d-flex justify-content-start align-items-start"></div>
                        <div id="loadLab"></div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="form-group">
                        <label>Project Details</label>
                        <textarea class="form-control textarea" placeholder="Project details ......................." id="proDetails"></textarea>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="update ml-auto mr-auto">
                      <button type="submit" class="btn btn-primary btn-round" id="upload_portfolio">Upload Portfolio</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer footer-black  footer-white ">
        <div class="container-fluid">
          <div class="row">
            <div class="credits ml-auto">
              <span class="copyright">
                © <script>
                  document.write(new Date().getFullYear())
                </script>, made with <i class="fa fa-heart heart"></i> by Khadec Technologies
              </span>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>
  <!--   Core JS Files   -->
  <script src="../assets/js/core/jquery.min.js"></script>
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>

  <!-- Chart JS -->
  <script src="../assets/js/plugins/chartjs.min.js"></script>
  <!--  Notifications Plugin    -->
  <script src="../assets/js/plugins/bootstrap-notify.js"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/paper-dashboard.min.js" type="text/javascript"></script><!-- Paper Dashboard DEMO methods, don't include it in your project! -->
  <script src="../assets/demo/demo.js"></script>
  <script>
    $(document).ready(function() {
      // Javascript method's body can be found in assets/assets-for-demo/js/demo.js
      demo.initChartsPages();
    });
  </script>

  <script type="module">
    // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, set, ref, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, uploadBytesResumable, deleteObject  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
  import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCuyHGrJ_7WMP_V0QGbbZWOYDS_oVA_gaA",
    authDomain: "khadec-tech.firebaseapp.com",
    databaseURL: "https://khadec-tech-default-rtdb.firebaseio.com",
    projectId: "khadec-tech",
    storageBucket: "khadec-tech.appspot.com",
    messagingSenderId: "623072304859",
    appId: "1:623072304859:web:bbb275fbd6773aa6cfb6fe"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

    var Files = []
    var FileReades = []
    var ImageLinksArray = []
    var hideModal;

    const selBtn = document.getElementById('progallery_images');
    const clearBtn = document.getElementById('clear_images');
    const submitButton = document.getElementById('submit_btn');
    const imgdiv = document.getElementById('imgdiv');
    const loadLab = document.getElementById('loadLab');
    const uploadPortfolio = document.getElementById('upload_portfolio');

      onAuthStateChanged(auth, (user) => {
        if(user){
          var uid = user.uid;
          var myEmail = user.email;

          document.getElementById('signed-user').innerHTML = myEmail;
        }else{
          window.location.href = '../../adminLogin.html'
        }
      })

    const userPropsRef = ref(database, 'portfolio/');
      onValue(userPropsRef, (snapshot) => {
        localStorage.setItem('Portfolio', JSON.stringify(snapshot))
      });

    const localPortfolio = JSON.parse(localStorage.getItem('Portfolio'));

    document.getElementById('add_new_portfolio').addEventListener('click', () => {
        document.getElementById('uploadPortfolio').classList.remove('d-none');
        document.getElementById('mainContent').classList.add('d-none');
    })

    document.getElementById('view_portfolio').addEventListener('click', () => {
        document.getElementById('mainContent').classList.remove('d-none');
        document.getElementById('uploadPortfolio').classList.add('d-none');
    })

              
    function showSignUpModal(){
        const myModalEl = document.getElementById('staticBackdrop')
        const modal = new bootstrap.Modal(myModalEl)
        modal.show()
      }
              
    function hideSignUpModal(){
        const myModalEl = document.getElementById('staticBackdrop')
        const modal = new bootstrap.Modal(myModalEl)
        modal.hide()
      }

    function getDeleteShortTitle(portID){
      let namey;
          for(let portItem in localPortfolio){
            if(portItem == portID){
              namey = localPortfolio[portItem].title;
            }
          }
          return namey.replace(/[^a-zA-Z0-9]/g,"");
        }

      function getImagesLength(portID){
        var imageCount = [];
        for(let portItem in localPortfolio){
            if(portItem == portID){
              let images = localPortfolio[portItem].image_links;
              for(let image in images){
                imageCount.push(images[image]);
              }
            }
          }
        return imageCount.length;
      }
      
      function strtLoading(){
        let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Portfolio Upload.</h5>
            </div>
          <div class="modal-body">
            <h5>Uploading your portfolio, Please wait...</h5>
            <!-- Modal Spinner -->
            <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-warning" role="status">
              <span class="visually-hidden"></span>
            </div>
            <div class="spinner-grow spinner-grow-sm text-success" role="status">
              <span class="visually-hidden"></span>
            </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        showSignUpModal();
      }

      function strtLoadingDelete(portID, client){

        let modContent = `
          <div class="modal-body p-4 text-center">
            <h5 class="mb-0">Delete portfolio</h5>
            <p class="mb-0">Are you sure you want to delete ${client} portfolio with ID ${portID} ?</p>
          </div>
          <div class="modal-footer flex-nowrap p-0">
            <button type="button" class="btn btn-lg btn-link btn-danger fs-6 text-decoration-none col-12 m-0 rounded-0 border-right" id="yesDelete"><strong>Yes, delete</strong></button>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        showSignUpModal();

        document.getElementById('yesDelete').addEventListener('click', (e) => {
          console.log(getDeleteShortTitle(portID))
          let modContent = `
          <div class="modal-body p-4 text-center">
            <h5 class="mb-0">Deleting portfolio</h5>
            <p class="mb-0">Please wait</p>
            <div class="modal-body">
              <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
              </div>
              <div class="spinner-grow spinner-grow-sm text-warning" role="status">
              </div>
              <div class="spinner-grow spinner-grow-sm text-success" role="status">
              </div>
            </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;

        
        for(let i = 1; i < getImagesLength(portID); i++){
            // Create a reference to the file to delete
            const desertRef = storageRef(storage, "TheImages/" + getDeleteShortTitle(portID)+ "/img#" + (i));

            // Delete the file
            deleteObject(desertRef).then(() => {
            // File deleted successfully
            console.log("image deleted successfully")
            }).catch((error) => {
            // Uh-oh, an error occurred!
            console.log(error)
            });
        }

          remove(ref(database,"portfolio/"+portID))
          .then(()=>{
            let modContent = `
              <div class="modal-body p-4 text-center">
                <h5 class="mb-0">Delete portfolio</h5>
                <p class="mb-0">Successfully deleted.</p>
              </div>
              <div class="modal-footer flex-nowrap p-0">
                <button type="button" class="btn btn-lg btn-link btn-success fs-6 text-decoration-none col-12 m-0 rounded-0" id="refreshPage"><strong>Ok</strong></button>
              </div>
            `
            document.getElementById('modalContent').innerHTML = modContent;
            document.getElementById('refreshPage').addEventListener('click', () => {
              window.location.reload();
            })

              }).catch((error)=>{
                  let modContent = `
                  <div class="modal-body p-4 text-center">
                    <h5 class="mb-0">Deleting unsuccessful</h5>
                    <p class="mb-0">${error}.</p>
                  </div>
                  <div class="modal-footer flex-nowrap p-0">
                    <button type="button" class="btn btn-lg btn-link btn-danger fs-6 text-decoration-none col-12 m-0 rounded-0" id="refreshPage"><strong>Try Again</strong></button>
                  </div>
                `
                document.getElementById('modalContent').innerHTML = modContent;
              });
          })
      }

      function finishedLoading(){
       let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Property Upload.</h5>
            </div>
          <div class="modal-body">
            <h5>Portfolio successfully uploaded.</h5>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="refreshPage">Close</button>
          </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        // document.getElementById('refreshPage').addEventListener('click', refresh)
      }

      function finishedLoadingError(){
       let modContent = `
            <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Property Upload.</h5>
            </div>
          <div class="modal-body">
            <h5>Image Upload failed. Please try again</h5>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="refreshPage">Close</button>
          </div>
          </div>
        `
        document.getElementById('modalContent').innerHTML = modContent;
        // document.getElementById('refreshPage').addEventListener('click', refresh)
      }
    function OpenFileDialog(e){
            e.preventDefault();
            let inp = document.createElement('input');
            inp.type = 'file';
            inp.multiple= 'multiple';

            inp.onchange = (e) => {
              AssignImgsToFilesArray(e.target.files);
              CreateImgTabs();
            }
            inp.click();
          }

          function AssignImgsToFilesArray(thefiles){
            let num = Files.length + thefiles.length;
            let looplim = (num <= 4) ? thefiles.length : (4 - Files.length);

            for(let i = 0; i < looplim ; i++){
              Files.push(thefiles[i]);
            }

            if (num > 4) alert("Maximum 4 images are allowed!")
          }

          function CreateImgTabs(){
            imgdiv.innerHTML = '';
            imgdiv.classList.add('imagesDivStyle');

              for (let i = 0; i < Files.length; i++) {
                FileReades[i] = new FileReader();

                FileReades[i].onload = function(){
                  var img = document.createElement('img');
                  img.id = 'imgNo' + i;
                  img.style = 'width: 30%';
                  img.classList.add('imgs');
                  img.src = FileReades[i].result;
                  imgdiv.append(img);
                }
                
                // FileReades[i].readAsDataURL(Files[i]);

                if (Files[i] && Files[i].type.match('image.*')) {
                  FileReades[i].readAsDataURL(Files[i]);
                } else {
                  // img.css('display', 'none');
                  // img.attr('src', '');
                }
              }
          };

          function getShortTitle(){
            let namey = document.getElementById("proTitle").value.substring(0,50);
            return namey.replace(/[^a-zA-Z0-9]/g,"");
          }

          function clearImages(e){
            e.preventDefault();
            var Files = []
            var ImageLinksArray = []
            imgdiv.innerHTML = '';
            imgdiv.classList.remove('imagesDivStyle');
          }

          function GetImgUploadProgress(){
            return 'Images Uploaded ' + ImageLinksArray.length +' ' + 'of' + ' ' + Files.length;
          }

          function IsAllImgsUploaded(){
            return ImageLinksArray.length == Files.length;
          }

          // function UploadAllImages(){

          // };
          uploadPortfolio.addEventListener('click', (e) => {
            e.preventDefault();
            strtLoading();
            for(let i = 0; i < Files.length; i++){
              UploadAnImage(Files[i], i);
            }
          })

//Upload All gallery images to the database
          function UploadAnImage(imgToUpload, imgNo){
            const ImageAddress = "TheImages/" + getShortTitle() + "/img#" + (imgNo+1);

            const sRef = storageRef(storage, ImageAddress);

            const UploadTask = uploadBytesResumable(sRef, imgToUpload);

            UploadTask.on('state-changed', (snapshot) => {
              loadLab.innerHTML =GetImgUploadProgress();
            },
            (error)=>{
              alert(error.message);
            },

            () => {
              getDownloadURL(UploadTask.snapshot.ref).then((downloadURL) => {
                ImageLinksArray.push(downloadURL);
                if(IsAllImgsUploaded()){
                  loadLab.innerHTML = "all images uploaded";
                  uploadPortfolioDetails();
                }
              });
            });

          }

          function uploadPortfolioDetails(){
            push(ref(database, 'portfolio/'), {
              title: document.getElementById('proTitle').value,
              client: document.getElementById('proClient').value,
              category: document.getElementById('category').value,
              date: document.getElementById('proDate').value,
              project_url: document.getElementById('proUrl').value,
              date: document.getElementById('proDate').value,
              details: document.getElementById('proDetails').value,
              image_links: ImageLinksArray
            })
            finishedLoading();
            window.location.reload();
          }
          
          // event listeners
          selBtn.addEventListener('click', OpenFileDialog);
          clearBtn.addEventListener('click', clearImages);

    //View the uploaded portfolio items for the currenctly signed in user
    for(let port in localPortfolio){
      document.getElementById('portfolio_list').innerHTML += `
        <tr style="overflow: hidden;" id="${port}">
          <td>
            ${localPortfolio[port].client}
          </td>
          <td>
            ${localPortfolio[port].date}
          </td>
          <td>
            ${localPortfolio[port].category}
          </td>
          <td class="text-right">
            <i class="bi bi-trash-fill deleteBtn" id="delete_item" style="color: red; cursor: pointer;"></i>
          </td>
        </tr>
      `
    }

    var deleteBtns = document.querySelectorAll('.deleteBtn');
    deleteBtns.forEach((item) => {
      item.addEventListener('click', (e) => {
        let portfolioID = e.target.parentElement.parentElement.id;
        let portClient = e.target.parentElement.previousElementSibling.previousElementSibling.previousElementSibling.textContent;
        strtLoadingDelete(portfolioID, portClient);
      })
    })

    document.getElementById('userLogout').addEventListener('click', () => {
      signOut(auth).then(() => {
        // Sign-out successful.       
        window.location.href = '../../adminLogin.html'; 
      }).catch((error) => {
        // An error happened.
      });
    })
  </script>
</body>

</html>
